FROM ghcr.io/uminetwork/foundry:latest AS foundry
FROM ghcr.io/uminetwork/optimism:latest AS optimism
WORKDIR /volume

RUN \
# Clone op-geth sources
    git clone https://github.com/ethereum-optimism/op-geth op-geth \
    && cd op-geth \
    && git checkout f2e69450 \
# Build op-geth
    && make geth

# Switch to clean container
FROM alpine:3.21.2
WORKDIR /volume

RUN \
# Install system dependencies for foundry and other scripts
    apk upgrade --no-cache \
# jq required at least by optimism deploy script
    && apk add --no-cache bash jq git \
# Clean up
    && rm -rf /tmp/*

# Copy entrypoint
COPY docker/op-geth.sh entrypoint.sh

# Copy genesis config generator
COPY server/src/tests/config.sh config.sh

# Copy ENV file that include Optimism wallet addresses
COPY .env .env
COPY docker/wait-for-it.sh /usr/local/bin/wait-for-it

# Grant run privileges to copied scripts
RUN chmod +x entrypoint.sh config.sh /usr/local/bin/wait-for-it

# Copy built binaries from build image and other dependencies
COPY --from=optimism /volume/op-geth/build/bin/geth /usr/local/bin/op-geth
COPY --from=optimism /volume/op-node/bin/op-node /usr/local/bin/op-node
COPY --from=optimism /volume/packages/contracts-bedrock /volume/packages/contracts-bedrock
COPY --from=optimism /volume/.git /volume/.git
COPY --from=optimism /root/.svm/0.8.15/solc-0.8.15 /root/.svm/0.8.15/solc-0.8.15
COPY --from=optimism /root/.svm/0.8.19/solc-0.8.19 /root/.svm/0.8.19/solc-0.8.19
COPY --from=optimism /root/.svm/0.8.25/solc-0.8.25 /root/.svm/0.8.25/solc-0.8.25
COPY --from=optimism /volume/op-program/bin/prestate.json /volume/op-program/bin/prestate.json
COPY --from=optimism /volume/op-program/bin/meta.json /volume/op-program/bin/meta.json
COPY --from=optimism /volume/op-program/bin/prestate-proof.json /volume/op-program/bin/prestate-proof.json
COPY --from=foundry /opt/foundry/out/cast /usr/local/bin/cast
COPY --from=foundry /opt/foundry/out/forge /usr/local/bin/forge

ENTRYPOINT [ "/volume/entrypoint.sh" ]
